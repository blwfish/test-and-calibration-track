<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speed Calibration Track</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e; color: #e0e0e0; padding: 16px;
    max-width: 600px; margin: 0 auto;
  }
  h1 { font-size: 1.3em; color: #e94560; margin-bottom: 4px; }
  .subtitle { color: #888; font-size: 0.85em; margin-bottom: 16px; }
  .card {
    background: #16213e; border-radius: 8px; padding: 16px;
    margin-bottom: 12px; border: 1px solid #0f3460;
  }
  .card h2 { font-size: 1em; color: #e94560; margin-bottom: 10px; }
  .status-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
  .status-label { color: #888; }
  .status-value { font-weight: 600; }
  .state-idle { color: #888; }
  .state-armed { color: #f5a623; }
  .state-measuring { color: #4fc3f7; }
  .state-complete { color: #66bb6a; }
  .btn-row { display: flex; gap: 8px; margin-top: 12px; }
  button {
    flex: 1; padding: 12px 16px; border: none; border-radius: 6px;
    font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.2s;
  }
  button:active { transform: scale(0.97); }
  .btn-arm { background: #e94560; color: white; }
  .btn-arm:hover { background: #d63851; }
  .btn-arm:disabled { background: #555; cursor: not-allowed; color: #888; }
  .btn-disarm { background: #0f3460; color: #e0e0e0; border: 1px solid #e94560; }
  .btn-disarm:hover { background: #1a4a7a; }
  .btn-disarm:disabled { background: #0a1e3a; color: #555; cursor: not-allowed; border-color: #333; }
  .sensors {
    display: flex; gap: 6px; justify-content: center; margin: 12px 0;
  }
  .sensor-dot {
    width: 40px; height: 40px; border-radius: 50%;
    background: #2a2a4a; border: 2px solid #444;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75em; font-weight: 600; transition: 0.3s;
  }
  .sensor-dot.triggered {
    background: #e94560; border-color: #e94560; color: white;
  }
  .result-speed {
    text-align: center; font-size: 2.5em; font-weight: 700;
    color: #4fc3f7; margin: 12px 0 4px;
  }
  .result-unit { text-align: center; color: #888; font-size: 0.85em; margin-bottom: 12px; }
  .result-detail { font-size: 0.85em; color: #aaa; margin-bottom: 4px; }
  .intervals {
    display: flex; gap: 4px; justify-content: center; margin: 8px 0;
  }
  .interval-bar {
    width: 30px; background: #0f3460; border-radius: 3px;
    display: flex; align-items: flex-end; justify-content: center;
    font-size: 0.6em; color: #888; min-height: 8px;
  }
  .interval-fill {
    background: #4fc3f7; border-radius: 3px; width: 100%;
    min-height: 4px; transition: height 0.3s;
  }
  .hidden { display: none; }
  .config-card input {
    width: 100%; padding: 8px; margin: 4px 0; border-radius: 4px;
    border: 1px solid #0f3460; background: #1a1a2e; color: #e0e0e0;
  }
  .config-card select {
    width: 100%; padding: 8px; margin: 4px 0; border-radius: 4px;
    border: 1px solid #0f3460; background: #1a1a2e; color: #e0e0e0;
  }
  .config-card label {
    font-size: 0.8em; color: #888; margin-top: 6px; display: block;
  }
  .config-status { font-size: 0.85em; color: #888; margin-bottom: 8px; }
  .conn-dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 6px;
  }
  .conn-dot.connected { background: #66bb6a; }
  .conn-dot.disconnected { background: #e94560; }
  .conn-dot.ws-connecting { background: #f5a623; }
  .log { font-family: monospace; font-size: 0.8em; color: #888;
    max-height: 150px; overflow-y: auto; margin-top: 8px;
    padding: 8px; background: #111; border-radius: 4px;
  }
  .log-entry { margin-bottom: 2px; }
  .log-entry.result { color: #4fc3f7; }
  .log-entry.error { color: #e94560; }
  .reading-big {
    text-align: center; font-size: 2em; font-weight: 700;
    color: #66bb6a; margin: 8px 0 4px;
  }
  .reading-unit { text-align: center; color: #888; font-size: 0.85em; margin-bottom: 8px; }
  .reading-row { display: flex; justify-content: space-around; text-align: center; margin: 8px 0; }
  .reading-item { flex: 1; }
  .reading-val { font-size: 1.3em; font-weight: 600; color: #4fc3f7; }
  .reading-lbl { font-size: 0.75em; color: #888; }

  /* --- Pull test --- */
  .pull-config { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
  .pull-config label { font-size: 0.8em; color: #888; white-space: nowrap; }
  .pull-config input {
    width: 70px; padding: 6px; border-radius: 4px; text-align: center;
    border: 1px solid #0f3460; background: #1a1a2e; color: #e0e0e0;
  }
  .pull-progress { margin: 10px 0; }
  .pull-progress-text { font-size: 0.85em; color: #888; margin-bottom: 4px; }
  .progress-bar {
    height: 8px; background: #0f3460; border-radius: 4px; overflow: hidden;
  }
  .progress-fill {
    height: 100%; background: #4fc3f7; border-radius: 4px;
    transition: width 0.3s;
  }
  .pull-results { margin-top: 10px; max-height: 200px; overflow-y: auto; }
  .pull-results table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
  .pull-results th {
    text-align: left; color: #888; padding: 4px 8px;
    border-bottom: 1px solid #0f3460;
  }
  .pull-results td { padding: 3px 8px; color: #e0e0e0; }
  .pull-results tr.peak td { color: #e94560; font-weight: 600; }
  .section-divider {
    border: none; border-top: 1px solid #0f3460; margin: 12px 0;
  }

  /* --- Throttle card --- */
  .throttle-status { font-size: 0.85em; color: #888; margin-bottom: 10px; }
  .addr-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
  .addr-row input {
    width: 100px; padding: 8px; border-radius: 4px;
    border: 1px solid #0f3460; background: #1a1a2e; color: #e0e0e0;
    font-size: 1em; text-align: center;
  }
  .speed-section { margin: 12px 0; }
  .speed-display {
    text-align: center; font-size: 2em; font-weight: 700;
    color: #4fc3f7; margin-bottom: 4px;
  }
  .speed-display .speed-pct {
    font-size: 0.5em; color: #888; font-weight: 400;
  }
  .speed-slider {
    width: 100%; -webkit-appearance: none; appearance: none;
    height: 8px; border-radius: 4px; background: #0f3460;
    outline: none; margin: 8px 0;
  }
  .speed-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 28px; height: 28px; border-radius: 50%;
    background: #4fc3f7; cursor: pointer; border: 2px solid #16213e;
  }
  .speed-slider::-moz-range-thumb {
    width: 28px; height: 28px; border-radius: 50%;
    background: #4fc3f7; cursor: pointer; border: 2px solid #16213e;
  }
  .speed-slider:disabled { opacity: 0.4; cursor: not-allowed; }
  .speed-slider:disabled::-webkit-slider-thumb { cursor: not-allowed; }
  .speed-labels {
    display: flex; justify-content: space-between;
    font-size: 0.75em; color: #555;
  }
  .dir-row { display: flex; gap: 8px; margin: 12px 0; }
  .dir-row button { font-size: 1.1em; padding: 14px; }
  .btn-fwd { background: #0f3460; color: #4fc3f7; border: 2px solid #4fc3f7; }
  .btn-fwd:hover { background: #1a4a7a; }
  .btn-fwd.active { background: #4fc3f7; color: #16213e; }
  .btn-rev { background: #0f3460; color: #f5a623; border: 2px solid #f5a623; }
  .btn-rev:hover { background: #1a4a7a; }
  .btn-rev.active { background: #f5a623; color: #16213e; }
  .btn-stop { background: #0f3460; color: #e0e0e0; border: 2px solid #666; }
  .btn-stop:hover { background: #1a4a7a; }
  .btn-estop {
    background: #c0392b; color: white; border: 2px solid #e74c3c;
    font-size: 1.2em; padding: 16px; letter-spacing: 1px;
    text-transform: uppercase; width: 100%; margin-top: 8px;
  }
  .btn-estop:hover { background: #e74c3c; }
  .fn-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
  .btn-fn {
    flex: 0 0 auto; min-width: 52px; padding: 8px 12px;
    background: #0f3460; color: #888; border: 1px solid #333;
    font-size: 0.85em; border-radius: 6px;
  }
  .btn-fn:hover { background: #1a4a7a; }
  .btn-fn.active { background: #e94560; color: white; border-color: #e94560; }
  .btn-fn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* Settings */
  details.settings { margin-top: 12px; }
  details.settings summary {
    cursor: pointer; color: #888; font-size: 0.9em;
    padding: 12px 0; user-select: none;
  }
  details.settings summary:hover { color: #e0e0e0; }
</style>
</head>
<body>

<h1>Speed Calibration Track</h1>
<div class="subtitle">
  <span class="conn-dot disconnected" id="connDot"></span>
  <span id="connText">Connecting...</span>
</div>

<!-- Locomotive Control -->
<div class="card">
  <h2>Locomotive Control</h2>
  <div class="throttle-status">
    <span class="conn-dot disconnected" id="bridgeDot"></span>
    <span id="bridgeStatus">No bridge</span>
  </div>
  <div class="addr-row">
    <input type="number" id="addrInput" placeholder="Addr" min="1" max="9999" value="">
    <button class="btn-arm" style="flex:1" onclick="doAcquire()">Acquire</button>
    <button class="btn-disarm" style="flex:1" onclick="doRelease()">Release</button>
  </div>
  <div class="speed-section">
    <div class="speed-display">
      <span id="speedStep">0</span><span>/126</span>
      <span class="speed-pct" id="speedPct">(0%)</span>
    </div>
    <input type="range" class="speed-slider" id="speedSlider"
           min="0" max="126" value="0" disabled
           oninput="onSpeedInput(this.value)">
    <div class="speed-labels"><span>0</span><span>63</span><span>126</span></div>
  </div>
  <div class="dir-row">
    <button class="btn-rev" id="btnRev" disabled onclick="doReverse()">&#9664; REV</button>
    <button class="btn-stop" id="btnThrottleStop" disabled onclick="doThrottleStop()">&#9632; STOP</button>
    <button class="btn-fwd active" id="btnFwd" disabled onclick="doForward()">FWD &#9654;</button>
  </div>
  <button class="btn-estop" onclick="doEstop()">E-STOP</button>
  <div class="fn-row" id="fnRow"></div>
</div>

<!-- Sensors -->
<div class="card">
  <h2>Sensors</h2>
  <div class="status-row">
    <span class="status-label">State</span>
    <span class="status-value state-idle" id="state">idle</span>
  </div>
  <div class="status-row">
    <span class="status-label">Sensors</span>
    <span class="status-value" id="sensorInfo">4 @ 100mm</span>
  </div>
  <div class="sensors" id="sensorDots"></div>
  <div class="btn-row">
    <button class="btn-arm" id="btnArm" onclick="sendCmd('arm')">Arm</button>
    <button class="btn-disarm" id="btnDisarm" onclick="sendCmd('disarm')">Disarm</button>
  </div>
</div>

<!-- Last Run -->
<div class="card hidden" id="resultCard">
  <h2>Last Run</h2>
  <div class="result-speed" id="avgSpeed">--</div>
  <div class="result-unit">scale mph (HO)</div>
  <div class="result-detail" id="resultDir"></div>
  <div class="result-detail" id="resultSensors"></div>
  <div class="result-detail" id="resultDuration"></div>
  <div style="margin-top:10px">
    <div class="result-detail">Interval speeds (mph):</div>
    <div class="intervals" id="intervalBars"></div>
  </div>
</div>

<!-- Drawbar Pull -->
<div class="card">
  <h2>Drawbar Pull</h2>
  <div class="reading-row">
    <div class="reading-item">
      <div class="reading-val" id="loadValue">--</div>
      <div class="reading-lbl">Current (g)</div>
    </div>
    <div class="reading-item">
      <div class="reading-val" id="pullPeak">--</div>
      <div class="reading-lbl">Peak (g)</div>
    </div>
  </div>
  <div class="status-row">
    <span class="status-label">Raw ADC</span>
    <span class="status-value" id="loadRaw">--</span>
  </div>
  <div class="status-row">
    <span class="status-label">Tared</span>
    <span class="status-value" id="loadTared">no</span>
  </div>
  <div class="btn-row">
    <button class="btn-arm" onclick="sendCmd('tare')">Tare</button>
    <button class="btn-disarm" onclick="sendCmd('load')">Read</button>
  </div>

  <hr class="section-divider">
  <div style="font-size:0.9em;color:#e94560;font-weight:600;margin-bottom:8px;">Pull + Vibration Sweep</div>

  <div class="pull-config">
    <label>Step inc:</label>
    <input type="number" id="pullStepInc" value="5" min="1" max="126">
    <label>Settle (s):</label>
    <input type="number" id="pullSettle" value="3.0" min="0.5" max="30" step="0.5">
  </div>

  <div class="btn-row">
    <button class="btn-arm" id="btnPullStart" onclick="pullTestStart()">Start Pull Test</button>
    <button class="btn-disarm" id="btnPullStop" onclick="pullTestAbort()" disabled>Stop</button>
  </div>

  <div class="pull-progress hidden" id="pullProgress">
    <div class="pull-progress-text" id="pullProgressText">--</div>
    <div class="progress-bar"><div class="progress-fill" id="pullProgressBar" style="width:0%"></div></div>
  </div>

  <div class="pull-results hidden" id="pullResults">
    <table>
      <thead><tr><th>Step</th><th>Throttle</th><th>Pull (g)</th><th>Vib P2P</th><th>Vib RMS</th></tr></thead>
      <tbody id="pullResultsBody"></tbody>
    </table>
  </div>
</div>

<!-- Vibration -->
<div class="card">
  <h2>Vibration</h2>
  <div class="reading-row">
    <div class="reading-item">
      <div class="reading-val" id="vibPP">--</div>
      <div class="reading-lbl">Peak-to-Peak</div>
    </div>
    <div class="reading-item">
      <div class="reading-val" id="vibRMS">--</div>
      <div class="reading-lbl">RMS</div>
    </div>
  </div>
  <div class="result-detail" id="vibInfo"></div>
  <div class="btn-row">
    <button class="btn-arm" onclick="sendCmd('vibration')">Capture</button>
  </div>
</div>

<!-- Audio -->
<div class="card">
  <h2>Audio</h2>
  <div class="reading-row">
    <div class="reading-item">
      <div class="reading-val" id="audioRMS">--</div>
      <div class="reading-lbl">RMS (dBFS)</div>
    </div>
    <div class="reading-item">
      <div class="reading-val" id="audioPeak">--</div>
      <div class="reading-lbl">Peak (dBFS)</div>
    </div>
  </div>
  <div class="result-detail" id="audioInfo"></div>
  <div class="btn-row">
    <button class="btn-arm" onclick="sendCmd('audio')">Capture</button>
  </div>
</div>

<!-- Log -->
<div class="card">
  <h2>Log</h2>
  <div class="log" id="log"></div>
</div>

<!-- Settings -->
<details class="settings">
  <summary>Settings</summary>
  <div class="card config-card">
    <h2>WiFi</h2>
    <div class="config-status" id="wifiStatus">--</div>
    <div class="config-status">MAC: <span id="macAddr" style="font-family:monospace;color:#e0e0e0;user-select:all">--</span></div>
    <select id="ssidSelect" onchange="document.getElementById('ssidInput').value=this.value">
      <option value="">Scan for networks...</option>
    </select>
    <input type="text" id="ssidInput" placeholder="SSID">
    <input type="password" id="passInput" placeholder="Password">
    <div class="btn-row">
      <button class="btn-arm" onclick="wifiConnect()">Connect</button>
      <button class="btn-disarm" onclick="wifiScan()">Scan</button>
      <button class="btn-disarm" onclick="wifiDisconnect()">Reset to AP</button>
    </div>
  </div>
  <div class="card config-card">
    <h2>MQTT</h2>
    <div class="config-status">
      <span class="conn-dot disconnected" id="mqttDot"></span>
      <span id="mqttStatus">Not configured</span>
    </div>
    <label>Broker (IP or hostname)</label>
    <input type="text" id="mqttBroker" placeholder="e.g. 192.168.1.100">
    <label>Topic prefix</label>
    <input type="text" id="mqttPrefix" placeholder="/cova">
    <label>Device name</label>
    <input type="text" id="mqttName" placeholder="speed-cal">
    <div class="btn-row">
      <button class="btn-arm" onclick="mqttSave()">Save</button>
      <button class="btn-disarm" onclick="mqttLoad()">Reload</button>
    </div>
  </div>
</details>

<script>
let ws;
let reconnTimer;
const MAX_LOG = 50;

// Throttle state
let throttleAcquired = false;
let throttleAddress = 0;
let throttleForward = true;
let fnState = {};
let speedDebounce = null;
let pullTestRunning = false;

function log(msg, cls='') {
  const el = document.getElementById('log');
  const d = document.createElement('div');
  d.className = 'log-entry ' + cls;
  const t = new Date().toLocaleTimeString();
  d.textContent = t + ' ' + msg;
  el.appendChild(d);
  while (el.children.length > MAX_LOG) el.removeChild(el.firstChild);
  el.scrollTop = el.scrollHeight;
}

function sendCmd(action) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({action}));
  }
}

function sendJson(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(obj));
  }
}

// --- Throttle ---

function updateThrottleUI() {
  const en = throttleAcquired;
  document.getElementById('speedSlider').disabled = !en;
  document.getElementById('btnFwd').disabled = !en;
  document.getElementById('btnRev').disabled = !en;
  document.getElementById('btnThrottleStop').disabled = !en;
  document.querySelectorAll('.btn-fn').forEach(b => b.disabled = !en);
  document.getElementById('btnFwd').classList.toggle('active', throttleForward);
  document.getElementById('btnRev').classList.toggle('active', !throttleForward);
  // Pull test start button depends on throttle
  document.getElementById('btnPullStart').disabled = !en || pullTestRunning;
}

function doAcquire() {
  const addr = parseInt(document.getElementById('addrInput').value);
  if (!addr || addr < 1) { log('Enter a valid DCC address', 'error'); return; }
  sendJson({action: 'acquire', address: addr});
  log('Acquiring throttle for ' + addr + '...');
}

function doRelease() {
  sendJson({action: 'release'});
  throttleAcquired = false;
  throttleAddress = 0;
  document.getElementById('speedSlider').value = 0;
  document.getElementById('speedStep').textContent = '0';
  document.getElementById('speedPct').textContent = '(0%)';
  updateThrottleUI();
}

function onSpeedInput(val) {
  const step = parseInt(val);
  document.getElementById('speedStep').textContent = step;
  document.getElementById('speedPct').textContent = '(' + Math.round(step / 1.26) + '%)';
  if (speedDebounce) clearTimeout(speedDebounce);
  speedDebounce = setTimeout(() => {
    sendJson({action: 'throttle_speed', value: step / 126.0});
  }, 80);
}

function doForward() {
  sendJson({action: 'forward'});
  throttleForward = true;
  updateThrottleUI();
}

function doReverse() {
  sendJson({action: 'reverse'});
  throttleForward = false;
  updateThrottleUI();
}

function doThrottleStop() {
  sendJson({action: 'throttle_stop'});
  document.getElementById('speedSlider').value = 0;
  document.getElementById('speedStep').textContent = '0';
  document.getElementById('speedPct').textContent = '(0%)';
}

function doEstop() {
  sendJson({action: 'estop'});
  document.getElementById('speedSlider').value = 0;
  document.getElementById('speedStep').textContent = '0';
  document.getElementById('speedPct').textContent = '(0%)';
  log('E-STOP!', 'error');
}

function toggleFn(num) {
  fnState[num] = !fnState[num];
  sendJson({action: 'function', num: num, state: fnState[num]});
  document.getElementById('fn' + num).classList.toggle('active', fnState[num]);
}

function buildFnButtons() {
  const row = document.getElementById('fnRow');
  for (let i = 0; i <= 8; i++) {
    const btn = document.createElement('button');
    btn.className = 'btn-fn';
    btn.id = 'fn' + i;
    btn.disabled = true;
    btn.textContent = 'F' + i;
    btn.onclick = () => toggleFn(i);
    fnState[i] = false;
    row.appendChild(btn);
  }
}

// --- Pull Test ---

function pullTestStart() {
  const stepInc = parseInt(document.getElementById('pullStepInc').value) || 5;
  const settleSec = parseFloat(document.getElementById('pullSettle').value) || 3.0;
  const settleMs = Math.round(settleSec * 1000);
  sendJson({action: 'pull_test_start', step_inc: stepInc, settle_ms: settleMs});
  pullTestRunning = true;
  document.getElementById('btnPullStart').disabled = true;
  document.getElementById('btnPullStop').disabled = false;
  document.getElementById('pullProgress').classList.remove('hidden');
  document.getElementById('pullResults').classList.add('hidden');
  document.getElementById('pullProgressText').textContent = 'Starting...';
  document.getElementById('pullProgressBar').style.width = '0%';
  log('Pull test started: inc=' + stepInc + ' settle=' + settleSec + 's');
}

function pullTestAbort() {
  sendJson({action: 'pull_test_abort'});
  log('Pull test abort requested', 'error');
}

function updatePullTestUI(running) {
  pullTestRunning = running;
  document.getElementById('btnPullStart').disabled = running || !throttleAcquired;
  document.getElementById('btnPullStop').disabled = !running;
}

function showPullProgress(d) {
  document.getElementById('pullProgress').classList.remove('hidden');
  const pct = d.total_steps > 0 ? Math.round(d.current_step_num / d.total_steps * 100) : 0;
  document.getElementById('pullProgressText').textContent =
    'Step ' + d.step + '/126 (' + d.current_step_num + ' of ' + d.total_steps + ')  ' +
    d.grams + 'g  Peak:' + d.peak_grams + 'g  Vib:' + (d.vib_rms || '--');
  document.getElementById('pullProgressBar').style.width = pct + '%';
  document.getElementById('pullPeak').textContent = d.peak_grams;
}

function showPullResults(d) {
  updatePullTestUI(false);
  document.getElementById('pullProgress').classList.add('hidden');
  document.getElementById('pullResults').classList.remove('hidden');
  document.getElementById('pullPeak').textContent = d.peak_grams;

  const tbody = document.getElementById('pullResultsBody');
  tbody.innerHTML = '';
  if (d.entries) {
    d.entries.forEach(e => {
      const tr = document.createElement('tr');
      if (e.step === d.peak_step && d.complete) tr.className = 'peak';
      tr.innerHTML = '<td>' + e.step + '</td><td>' + e.pct + '%</td><td>' + e.grams + '</td>' +
        '<td>' + (e.vib_pp != null ? e.vib_pp : '--') + '</td>' +
        '<td>' + (e.vib_rms != null ? e.vib_rms : '--') + '</td>';
      tbody.appendChild(tr);
    });
  }
  const status = d.complete ? 'complete' : 'aborted';
  log('Pull test ' + status + ': ' + (d.entries ? d.entries.length : 0) +
    ' entries, peak=' + d.peak_grams + 'g at step ' + d.peak_step);
}

// --- Sensors ---

function updateState(state) {
  const el = document.getElementById('state');
  el.textContent = state;
  el.className = 'status-value state-' + state;
  document.getElementById('btnArm').disabled = (state === 'armed' || state === 'measuring');
}

function updateSensorDots(count, triggered) {
  const c = document.getElementById('sensorDots');
  c.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const dot = document.createElement('div');
    dot.className = 'sensor-dot' + (triggered && triggered[i] ? ' triggered' : '');
    dot.textContent = 'S' + i;
    c.appendChild(dot);
  }
}

function showResult(d) {
  document.getElementById('resultCard').classList.remove('hidden');
  document.getElementById('avgSpeed').textContent = d.avg_speed_mph || '--';
  document.getElementById('resultDir').textContent = 'Direction: ' + (d.direction || '?');
  document.getElementById('resultSensors').textContent =
    'Sensors: ' + d.sensors_triggered + ' / ' + document.getElementById('sensorDots').children.length;
  document.getElementById('resultDuration').textContent =
    'Duration: ' + (d.duration_ms ? d.duration_ms.toFixed(1) + ' ms' : '--');
  const bars = document.getElementById('intervalBars');
  bars.innerHTML = '';
  if (d.speeds_mph && d.speeds_mph.length > 0) {
    const max = Math.max(...d.speeds_mph.map(Number));
    d.speeds_mph.forEach((v) => {
      const pct = max > 0 ? (Number(v) / max * 60 + 10) : 10;
      const bar = document.createElement('div');
      bar.className = 'interval-bar';
      bar.style.height = '70px';
      bar.innerHTML = '<div class="interval-fill" style="height:' + pct + '%"></div>';
      bar.title = v + ' mph';
      bars.appendChild(bar);
    });
  }
  updateSensorDots(d.triggered ? d.triggered.length : 0, d.triggered);
}

// --- Messages ---

function handleMessage(msg) {
  try {
    const d = JSON.parse(msg);

    if (d.type === 'status') {
      updateState(d.state);
      document.getElementById('sensorInfo').textContent =
        d.sensors + ' @ ' + d.spacing_mm + 'mm';
      document.getElementById('wifiStatus').textContent =
        d.wifi_mode + ' | ' + d.ssid + ' | ' + d.ip;
      if (d.mac) document.getElementById('macAddr').textContent = d.mac;
      updateSensorDots(d.sensors, null);
      // MQTT
      const mqttDot = document.getElementById('mqttDot');
      const mqttStat = document.getElementById('mqttStatus');
      if (d.mqtt_broker && d.mqtt_broker.length > 0) {
        mqttDot.className = 'conn-dot ' + (d.mqtt_connected ? 'connected' : 'disconnected');
        mqttStat.textContent = (d.mqtt_connected ? 'Connected' : 'Disconnected') +
          ' | ' + d.mqtt_broker;
      } else {
        mqttDot.className = 'conn-dot disconnected';
        mqttStat.textContent = 'Not configured';
      }
      // Throttle from status
      if ('throttle_acquired' in d) {
        throttleAcquired = d.throttle_acquired;
        throttleAddress = d.throttle_address;
        throttleForward = d.throttle_forward;
        if (d.throttle_address > 0)
          document.getElementById('addrInput').value = d.throttle_address;
        updateThrottleUI();
      }

    } else if (d.type === 'result') {
      showResult(d);
      log('Run: ' + (d.avg_speed_mph || '?') + ' mph ' + (d.direction || ''), 'result');
      updateState('complete');

    } else if (d.type === 'throttle') {
      throttleAcquired = d.acquired;
      throttleAddress = d.address;
      throttleForward = d.forward;
      const st = d.status || '';
      const dot = document.getElementById('bridgeDot');
      const txt = document.getElementById('bridgeStatus');
      if (d.acquired) {
        dot.className = 'conn-dot connected';
        txt.textContent = 'Addr ' + d.address + (d.forward ? ' Fwd' : ' Rev');
        document.getElementById('addrInput').value = d.address;
      } else if (st === 'READY') {
        dot.className = 'conn-dot connected';
        txt.textContent = 'Bridge ready';
      } else if (st.startsWith('ERROR') || st.startsWith('FAILED')) {
        dot.className = 'conn-dot disconnected';
        txt.textContent = st;
        log('Bridge: ' + st, 'error');
      } else if (st.startsWith('ACQUIRING')) {
        dot.className = 'conn-dot ws-connecting';
        txt.textContent = st + '...';
      } else {
        dot.className = 'conn-dot disconnected';
        txt.textContent = st || 'No bridge';
      }
      // Speed ack
      if (st.startsWith('SPEED ')) {
        const spd = parseFloat(st.substring(6));
        const step = Math.round(spd * 126);
        document.getElementById('speedSlider').value = step;
        document.getElementById('speedStep').textContent = step;
        document.getElementById('speedPct').textContent = '(' + Math.round(step / 1.26) + '%)';
      }
      if (st === 'STOPPED' || st === 'ESTOPPED') {
        document.getElementById('speedSlider').value = 0;
        document.getElementById('speedStep').textContent = '0';
        document.getElementById('speedPct').textContent = '(0%)';
      }
      updateThrottleUI();
      if (st && st !== 'READY' && !st.startsWith('SPEED'))
        log('Bridge: ' + st);

    } else if (d.type === 'load') {
      document.getElementById('loadValue').textContent = d.grams || '--';
      document.getElementById('loadRaw').textContent = d.raw || '--';
      document.getElementById('loadTared').textContent = d.tared ? 'yes' : 'no';
      log('Load: ' + (d.grams || '?') + ' g');

    } else if (d.type === 'vibration') {
      document.getElementById('vibPP').textContent = d.peak_to_peak || '--';
      document.getElementById('vibRMS').textContent = d.rms || '--';
      document.getElementById('vibInfo').textContent =
        d.samples + ' samples / ' + d.duration_ms + ' ms';
      log('Vibration: p2p=' + d.peak_to_peak + ' rms=' + d.rms);

    } else if (d.type === 'audio') {
      document.getElementById('audioRMS').textContent = d.rms_db || '--';
      document.getElementById('audioPeak').textContent = d.peak_db || '--';
      document.getElementById('audioInfo').textContent =
        d.samples + ' samples / ' + d.duration_ms + ' ms';
      log('Audio: rms=' + d.rms_db + ' dB, peak=' + d.peak_db + ' dB');

    } else if (d.type === 'pull_progress') {
      showPullProgress(d);

    } else if (d.type === 'pull_test') {
      showPullResults(d);
    }
  } catch(e) {
    log('Parse error: ' + e, 'error');
  }
}

// --- WebSocket ---

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');
  ws.onopen = () => {
    document.getElementById('connDot').className = 'conn-dot connected';
    document.getElementById('connText').textContent = 'Connected';
    log('WebSocket connected');
    sendCmd('status');
    if (reconnTimer) { clearTimeout(reconnTimer); reconnTimer = null; }
  };
  ws.onmessage = (e) => handleMessage(e.data);
  ws.onclose = () => {
    document.getElementById('connDot').className = 'conn-dot disconnected';
    document.getElementById('connText').textContent = 'Disconnected';
    log('WebSocket disconnected', 'error');
    reconnTimer = setTimeout(connect, 2000);
  };
  ws.onerror = () => { ws.close(); };
}

// --- WiFi ---
function wifiScan() {
  fetch('/api/wifi/scan').then(r => r.json()).then(d => {
    if (d.scanning) { setTimeout(wifiScan, 2000); log('Scanning...'); return; }
    const sel = document.getElementById('ssidSelect');
    sel.innerHTML = '<option value="">Select network...</option>';
    (d.networks || []).forEach(n => {
      const opt = document.createElement('option');
      opt.value = n.ssid;
      opt.textContent = n.ssid + ' (' + n.rssi + ' dBm)' + (n.open ? ' [open]' : '');
      sel.appendChild(opt);
    });
    log('Found ' + (d.networks || []).length + ' networks');
  }).catch(e => log('Scan error: ' + e, 'error'));
}
function wifiConnect() {
  const ssid = document.getElementById('ssidInput').value;
  const pass = document.getElementById('passInput').value;
  if (!ssid) { log('Enter an SSID', 'error'); return; }
  fetch('/api/wifi/connect', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ssid, password: pass})
  }).then(() => log('Connecting to ' + ssid + '... device will reboot'))
    .catch(e => log('Connect error: ' + e, 'error'));
}
function wifiDisconnect() {
  fetch('/api/wifi/disconnect', {method: 'POST'})
    .then(() => log('Resetting to AP mode... device will reboot'))
    .catch(e => log('Error: ' + e, 'error'));
}

// --- MQTT ---
function mqttLoad() {
  fetch('/api/mqtt').then(r => r.json()).then(d => {
    document.getElementById('mqttBroker').value = d.broker || '';
    document.getElementById('mqttPrefix').value = d.prefix || '';
    document.getElementById('mqttName').value = d.name || '';
    const mqttDot = document.getElementById('mqttDot');
    const mqttStat = document.getElementById('mqttStatus');
    if (d.broker && d.broker.length > 0) {
      mqttDot.className = 'conn-dot ' + (d.connected ? 'connected' : 'disconnected');
      mqttStat.textContent = (d.connected ? 'Connected' : 'Disconnected') + ' | ' + d.broker;
    } else {
      mqttDot.className = 'conn-dot disconnected';
      mqttStat.textContent = 'Not configured';
    }
    log('MQTT config loaded');
  }).catch(e => log('MQTT load error: ' + e, 'error'));
}
function mqttSave() {
  const broker = document.getElementById('mqttBroker').value.trim();
  const prefix = document.getElementById('mqttPrefix').value.trim();
  const name = document.getElementById('mqttName').value.trim();
  fetch('/api/mqtt', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({broker, prefix, name})
  }).then(r => r.json()).then(d => {
    if (d.ok) log('MQTT config saved. Broker=' + broker);
    else log('MQTT save error: ' + (d.error || 'unknown'), 'error');
  }).catch(e => log('MQTT save error: ' + e, 'error'));
}

// --- Init ---
buildFnButtons();
connect();
mqttLoad();
</script>
</body>
</html>
